AJG23005 中 天花

課題
サンプルプログラムex7_passing_object.cppを実行すると、43行目の関数showが呼び出されたところでエラーが出る。
しかし、関数 show の仮引数を参照 (strtype &x) にするとエラーは出ない。
その理由を、関数showの仮引数を参照にしない場合と参照にする場合の両方について、
関数show側でのオブジェクトの作成、破棄や、破棄に伴うデストラクタ実行の有無、参照渡し、デストラクタの挙動を中心に説明せよ。
なお、25行目の strcpy(p, s) を実行すると、sが指すメモリ領域に格納されている文字列が、pが指すメモリ領域にコピーされることに注意せよ。

回答
関数 show の引数の受け取り方を、値渡しにするのか参照渡しにするのかによって、オブジェクトの作成や破棄、それに伴うデストラクタの実行に違いが出る。
それによって、 関数 show の挙動が変化していると考えられる。
以下で、関数 show の引数に値渡しを使用する場合と参照渡しを使用する場合のそれぞれの動作の違いを説明する。

・関数 show の仮引数が値渡しの場合
値渡しでは、関数 show が呼ばれると、引数として渡された strtype オブジェクト a がコピーされ、新しいオブジェクト x が作成される。
コンストラクタが呼び出されると、x は a と同じメモリ領域 p を指し示すようになる。
その後、関数 show が終了すると x のデストラクタが呼ばれるが、このとき、x.p が a.p と同じメモリ領域を指しているために、x.p のメモリと一緒に a.p のメモリも解放されてしまう。a のメモリが解放された後に a を使用することができず、これが、show(a) を2回目に呼び出すときに発生するエラーの原因となっている。

・関数 show の仮引数が参照渡しの場合
参照渡しでは、関数 show に渡されるオブジェクトは新たにコピーされることはなく、x は元のオブジェクト a と同じオブジェクトを指し、x と a は 同一のメモリ領域を指し続ける。したがって、x.p と a.p は同じメモリ領域を指しているので、a のメモリが解放されることはない。よって、a.p は破棄されず、show(a) を何度呼び出しても問題は発生しない。
